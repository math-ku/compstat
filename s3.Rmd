---
title: "S3 Objects"
subtitle: Computational Statistics
author: "Johan Larsson, Niels Richard Hansen"
date: "September 3, 2024"
---

```{r init, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(gridExtra)
library(microbenchmark)
knitr::opts_chunk$set(
  fig.width = 4.8,
  fig.height = 4.2,
  fig.retina = 3,
  fig.align = "center",
  dev.args = list(pointsize = 16)
)

theme_set(theme_grey(base_size = 18))

phipsi <- read.table("phipsi.tsv", header = TRUE)
phipsi[, c("phi", "psi")] <- pi * phipsi[, c("phi", "psi")] / 180
```

## Functionals

The function `integrate()` takes a function as argument and returns the 
value of numerically integrating the function.
--


It is an example of a *functional*. 
--


```{r}
integral <- integrate(sin, 0, 1)
integral
```

The numerical value of the integral 
$$\int_0^1 \sin(x) \mathrm{d}x$$ 
is nicely printed above---including an indication of the numerical error. 

---
## Return Values

In fact, `integrate()` returns a list with a *class label*.

```{r}
str(integral)
```
--

Return values that don't fit into one of the basic data structures 
can be returned as a list as above.

---
## The Return Value of `integrate()`

The class label can be extracted directly.

```{r}
class(integral)
```
--


When you ask R to print this object it doesn't just print out all the values in the list. 
It gives a suitably formatted result as implemented 
in the print method for objects of class integrate. 

---
## Printing Objects of Class Integrate 

```{r}
stats:::print.integrate
```

(The `print.integrate()` function is not exported from the stats package. It is in the 
namespace of the stats package, and to access it directly we use `stats:::`.)

---
## Histogram Objects

```{r temp-hist, fig.width = 9, fig.height = 6}
phi_hist <- hist(phipsi$phi, main = NULL)
```

---
## Histogram Objects

```{r}
class(phi_hist)
```

--

```{r}
str(phi_hist)
```

---
## Histogram Objects

```{r}
phi_hist[1:4]
```


---
## Getting Help 

You can find documentation for `plot()` using e.g. 

```{r help-plot, eval = FALSE}
?plot
```

--
However, this will be uninformative on how an object of class histogram is plotted. 
Try instead 

```{r help-plot-histogram, eval = FALSE}
?plot.histogram
```

This will give the documentation for the plot method for objects of class histogram. 


---
## S3 Overview

* S3 classes are standard data structures (typically lists) with *class labels*.
--

* It is an informal system. No checks of object content.
--

* One implements a *generic* function via `UseMethod()`. E.g.
```{r, eval=FALSE}
plot
```

```{r, echo=FALSE}
cat(deparse(plot))
```

--

* **Methods** for specific classes are implemented as standard R functions 
with the naming convention `f.classname()` for a method for class `classname` of the function `f()`. 
--

* The system is widely used to write methods for the generic functions `print()`, 
`plot()` and `summary()`. 


---
## Constructing a New Class

```{r, echo=FALSE}
count_zeros_vec <- function(x) {
  sum(x == 0)
}
```

Recall the function `count_zeros_vec()` that counts the number of zeros in a vector.
--


If we need this number many times it is beneficial to compute it once and then 
extract it whenever needed. 

--

We first write a *constructor function* that returns a list with a class
label.

```{r}
count_object <- function(x) {
  structure(
    list(
      x = x,
      n = count_zeros_vec(x)
    ),
    class = "count_object"
  )
}
```

---
## A Data Example

```{r, echo=-1}
set.seed(1234)
count_data <- count_object(rpois(10, 2))
count_data
```

---
## The Generic Function and a Method

To activate looking up a method for a specific class, one needs to tell R 
that the function `count_zeros()` is a *generic function*. 

```{r}
count_zeros <- function(x) {
  UseMethod("count_zeros")
}
```

--
Then we can implement a class specific version of `count_zeros()`.

```{r}
count_zeros.count_object <- function(x) {
  x$n
}
```

--
And we can also implement a print method

```{r}
print.count_object <- function(x) {
  cat(x$x, "\n")
}
```

---
## Trying It Out

```{r}
count_data ## Print data
count_zeros(count_data)
```

---
## Exercises

You should now do [Exercises A.7-A.10 in CSwR](https://cswr.nrhstat.org/app-r#app-ex).



